name: Keep star-io awake (main + staff)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Ping both star-io endpoints (tolerant)
        shell: bash
        run: |
          # bash -e ã‚’äº‹å®Ÿä¸Šç„¡åŠ¹åŒ–ï¼ˆcurlå¤±æ•—ã§ã‚‚ç¶šè¡Œï¼‰
          set +e

          URLS=(
            "https://star-io-hc9c.onrender.com"
            "https://star-io-hc9c.onrender.com/staff/update-order-statuses"
          )

          echo "ğŸ” Start pinging at $(date -u)"
          OK=0
          for URL in "${URLS[@]}"; do
            echo "ğŸŒ Pinging $URL ..."
            CODE=$(curl -sS -o /dev/null -L \
              --max-time 45 \
              --retry 5 \
              --retry-all-errors \
              --retry-delay 5 \
              -w "%{http_code}" "$URL" || echo 000)
            echo "â†ª HTTP $CODE"

            # 2xx/3xx ã‚’æˆåŠŸæ‰±ã„
            if [[ "$CODE" -ge 200 && "$CODE" -lt 400 ]]; then
              OK=1
            fi
          done

          # ä¸¡æ–¹ã¨ã‚‚å¤±æ•—ã—ãŸã¨ãã ã‘ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã«ã™ã‚‹
          if [[ "$OK" -eq 0 ]]; then
            echo "âŒ all endpoints failed"
            exit 1
          else
            echo "âœ… at least one endpoint is alive"
          fi
